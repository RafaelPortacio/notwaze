<html>
    <head>
        <title>Not Waze</title>
        <meta charset="UTF-8" />

        <!-- Include Leaflet -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

        <style>

body {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
}

.header {
    height: 3em;
    padding: 4px;
}

#map {
    height: calc(100% - 3em);
    width:  100%;
}

        </style>
    </head>
    <body>
        <div class="header">
            <form>
                <input class="header" style="width: 40%" type="text" id="starting-point-input" name="starting-point" placeholder="Starting Location..." />
                <input class="header" style="width: 40%" type="text" id="destination-input"    name="destination" placeholder="Destination..." />
                <input class="header" style="width: 18%" type="submit" value="Go" />
            </form>
        </div>

        <div id="map"></div>

        <script>

// Add the map
var leaflet_map = L.map('map').setView([51.505, -0.09], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 19,
}).addTo(leaflet_map);

// Draw shortest paths, if there are any
var params = (new URL(document.location)).searchParams;

if (params.has("starting-point") && params.has("destination")) {
    var url = "http://localhost:8080/shortestPath?startPoint="
        + params.get("starting-point")
        + "&endPoint="
        + params.get("destination");
    fetch(url).then(function(response) {
        return response.json();
    }).then(function(data) {
        console.log(data);
        var starting_point = data["shortest-paths"][0]["path"][0];
        var ending_point =   data["shortest-paths"][0]["path"][data["shortest-paths"][0]["path"].length-1];

        // Add markers
        L.marker([starting_point.latitude, starting_point.longitude]).addTo(leaflet_map);
        L.marker([ending_point.  latitude, ending_point.  longitude]).addTo(leaflet_map);

        // Draw lines for indicating paths
        let extents = data["shortest-paths"].map(function(path) {
            let latlongs = path["path"].map(x => [x.latitude, x.longitude]);
            let polyline = L.polyline(latlongs, {
                color: "blue",
                weight: 7,
                opacity: 0.75,
            }).addTo(leaflet_map).bindPopup("ETA: " + path["eta"] + "secs");
            polyline.on("mouseover", _ => polyline.openPopup());
            polyline.on("mouseout",  _ => polyline.closePopup());
            return polyline.getBounds();
        });
        leaflet_map.fitBounds(extents.reduce((acc, x) => acc.extend(x)));
    });
}

        </script>
    </body>
</html>
